<ng-container>
  <mat-toolbar class="toolbar-sticky" style="padding: 15px 0px;" color="primary">
    <mat-toolbar-row>
      <span>{{selectedRequest?.proposalName | titlecase}} - Disbursments</span>
      <span class="example-spacer"></span>
    </mat-toolbar-row>
  </mat-toolbar>
</ng-container>

<div class="m-20">
  <div class="box-heading">
    <span class="pl-0">Initial Advance(s)</span>
  </div>
  <ng-container>
    <mat-accordion class="example-headers-align">

      <mat-expansion-panel class="mb-5" [expanded]="step === selectedRequest?.initialAdvance.id"
        (opened)="setStep(selectedRequest?.initialAdvance, selectedRequest?.initialAdvance.id, 'initial')">
        <mat-expansion-panel-header>
          <mat-panel-title>
            Initial Advance
          </mat-panel-title>
          <mat-panel-description>
            <span id="comment">
              {{selectedRequest?.initialAdvance?.status}}
            </span>
            <span id="comment">
              {{selectedRequest?.initialAdvance?.subStatus}}
            </span>

            <mat-icon *ngIf="selectedRequest !== null">
              {{'unfold_more'}}
            </mat-icon>
          </mat-panel-description>
        </mat-expansion-panel-header>

        <!-- FORM CONTROLS FOR FIP -->
        <ng-container *ngIf="loggedUser?.role === 'fip'">

          <div class="row">
            <div class="col-md-12 mb-3">
              <div class="d-flex flex-fill justify-content-between align-items-center">
                <div class="d-flex align-items-center" style="width: 33%;">
                  <span style="border: 1px solid;padding: 2px 10px;margin-right:10px;width:15%;">X</span>
                  <span>Initial Advance</span>
                </div>
                <div class="d-flex align-items-center" style="width: 33%;">
                  <span style="border: 1px solid;padding: 2px 10px;margin-right:10px;width:15%;">&nbsp;</span>
                  <span>Liquidation Only</span>
                </div>
                <div class="d-flex align-items-center" style="width: 33%;">
                  <span style="border: 1px solid;padding: 2px 10px;margin-right:10px;width:15%;">&nbsp;</span>
                  <span>Liquidation & Replenishment</span>
                </div>
              </div>
            </div>
            <div class="col-md-12 mb-3">
              <div class="d-flex flex-fill justify-content-between align-items-center">
                <div class="d-flex align-items-center" style="width: 33%;">
                  <span style="border: 1px solid;padding: 2px 10px;margin-right:10px;width:15%;">&nbsp;</span>
                  <span>Advance</span>
                </div>
                <div class="d-flex align-items-center" style="width: 33%;">
                  <span style="border: 1px solid;padding: 2px 10px;margin-right:10px;width:15%;">&nbsp;</span>
                  <span>Replenishment</span>
                </div>
                <div class="d-flex align-items-center" style="width: 33%;">
                  <span style="border: 1px solid;padding: 2px 10px;margin-right:10px;width:15%;">&nbsp;</span>
                  <span>Direct Payment</span>
                </div>
              </div>
            </div>
          </div>

          <!-- FORM FOR ADVANCE EXTRA FIELDS -->
          <form [formGroup]="advanceForm">
            <div class="row">
              <div class="col-md-12">
                <mat-form-field appearance="outline">
                  <mat-label>Payees Name</mat-label>
                  <input formControlName="payeesName" matInput type="text" placeholder="enter here...">
                </mat-form-field>
              </div>
              <div class="col-md-12">
                <mat-form-field appearance="outline">
                  <mat-label>Payees Address</mat-label>
                  <input formControlName="payeesAddress" matInput type="text" placeholder="enter here...">
                </mat-form-field>
              </div>
              <div class="col-md-12">
                <mat-form-field appearance="outline">
                  <mat-label>Bank Name</mat-label>
                  <input formControlName="bankName" matInput type="text" placeholder="enter here...">
                </mat-form-field>
              </div>
              <div class="col-md-12">
                <mat-form-field appearance="outline">
                  <mat-label>Bank Address</mat-label>
                  <input formControlName="bankAddress" matInput type="text" placeholder="enter here...">
                </mat-form-field>
              </div>
              <div class="col-md-6">
                <mat-form-field appearance="outline">
                  <mat-label>Payees Account #</mat-label>
                  <input formControlName="payeesAccount" matInput type="text" placeholder="enter here...">
                </mat-form-field>
              </div>
              <div class="col-md-6">
                <mat-form-field appearance="outline">
                  <mat-label>Swift Code</mat-label>
                  <input formControlName="swiftCode" matInput type="text" placeholder="enter here...">
                </mat-form-field>
              </div>
              <div class="col-md-12">
                <mat-form-field appearance="outline">
                  <mat-label>Special Payment Instruction</mat-label>
                  <input formControlName="specialPaymentInstruction" matInput type="text" placeholder="enter here...">
                </mat-form-field>
              </div>
            </div>
          </form>

          <!-- SELECT COSTS FORM FIELD -->
          <div class="row d-flex align-items-center">
            <div class="col-md-9">

              <mat-form-field appearance="outline" *ngIf="apiCosts === null">
                <mat-label>Select Cost(s)</mat-label>
                <mat-select matNativeControl [formControl]="costsData" multiple>
                  <!-- OPTIONS FILTER -->
                  <mat-form-field class="p-3 filter-input" *ngIf="apiCosts === null" appearance="outline">
                    <mat-label>Filter</mat-label>
                    <input matInput type="text" placeholder="Enter keyword..." [(ngModel)]="filterQuery">
                  </mat-form-field>
                  <mat-select-trigger>
                    <span *ngFor="let item of costsData.value; let i=index">
                      <span *ngIf="i===0">{{item.title}}</span>
                    </span>
                    <span *ngIf="costsData.value?.length > 1">
                      (+{{costsData.value.length - 1}} others)
                    </span>
                  </mat-select-trigger>
                  <mat-option *ngFor="let item of costSelections | costsFilter:filterQuery" [value]="item">{{item.title
                    | titlecase}}</mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline" *ngIf="apiCosts !== null">
                <mat-label>Select Cost</mat-label>
                <mat-select matNativeControl [formControl]="costsData">
                  <!-- OPTIONS FILTER -->
                  <mat-form-field class="p-3 filter-input" *ngIf="apiCosts !== null" appearance="outline">
                    <mat-label>Filter</mat-label>
                    <input matInput type="text" placeholder="Enter keyword..." [(ngModel)]="filterQuery">
                  </mat-form-field>
                  <mat-option *ngFor="let item of costSelections | costsFilter:filterQuery" [value]="item">{{item.title
                    | titlecase}}</mat-option>
                </mat-select>
              </mat-form-field>

            </div>
            <div class="col-md-2">
              <button [disabled]="!costsData.valid" mat-raised-button color="primary" (click)="addDataCosts();">Add
                Costs</button>
            </div>
          </div>

        </ng-container>

        <!-- SELECTED ADVANCE COSTS FOR FIP -->
        <ng-container *ngIf="loggedUser?.role === 'fip'">
          <div class="row d-flex header-box align-items-center mt-3">
            <div class="col-md-6 heading-contain">
              <span class="pl-2">Title</span>
            </div>
            <div class="col-md-6 heading-contain">
              <span class="pl-2">Amount</span>
            </div>
          </div>
          <div class="row d-flex cost-box align-items-center mt-2" *ngFor="let item of apiCosts; let i = index;">
            <div class="col-md-6">
              <span>{{item.title}}</span>
            </div>
            <div class="col-md-6">
              <mat-form-field appearance="outline">
                <mat-label>Amount</mat-label>
                <input [disabled]="(selectedAdvanceItem?.status === 'Approved' || 
                  selectedAdvanceItem?.status === 'Under Review' ||
                  selectedAdvanceItem?.status === 'Completed' ||
                  selectedAdvanceItem?.status === 'Review Pending' ||
                  selectedAdvanceItem?.status === 'Review Completed' ||
                  selectedAdvanceItem?.status === 'Marked To PO' ||
                  selectedAdvanceItem?.subStatus === 'Approved')" matInput type="number" placeholder="Enter Amount..."
                  [(ngModel)]="item.amount">
              </mat-form-field>
            </div>
          </div>
        </ng-container>

        <!-- SELECTED ADVANCE COSTS FOR OTHERS SUBMITTED BY FIP -->
        <div class="row">
          <ng-container *ngIf="loggedUser?.role !== 'fip'">
            <div class="col-md-7">
              <div class="row" *ngIf="selectedAdvanceItem !== null">
                <div class="col-md-12">
                  <mat-form-field appearance="outline">
                    <mat-label>Payees Name</mat-label>
                    <input disabled [(ngModel)]="selectedAdvanceItem.payeesName" matInput type="text"
                      placeholder="enter here...">
                  </mat-form-field>
                </div>
                <div class="col-md-12">
                  <mat-form-field appearance="outline">
                    <mat-label>Payees Address</mat-label>
                    <input disabled [(ngModel)]="selectedAdvanceItem.payeesAddress" matInput type="text"
                      placeholder="enter here...">
                  </mat-form-field>
                </div>
                <div class="col-md-12">
                  <mat-form-field appearance="outline">
                    <mat-label>Bank Name</mat-label>
                    <input disabled [(ngModel)]="selectedAdvanceItem.bankName" matInput type="text"
                      placeholder="enter here...">
                  </mat-form-field>
                </div>
                <div class="col-md-12">
                  <mat-form-field appearance="outline">
                    <mat-label>Bank Address</mat-label>
                    <input disabled [(ngModel)]="selectedAdvanceItem.bankAddress" matInput type="text"
                      placeholder="enter here...">
                  </mat-form-field>
                </div>
                <div class="col-md-6">
                  <mat-form-field appearance="outline">
                    <mat-label>Payees Account #</mat-label>
                    <input disabled [(ngModel)]="selectedAdvanceItem.payeesAccount" matInput type="text"
                      placeholder="enter here...">
                  </mat-form-field>
                </div>
                <div class="col-md-6">
                  <mat-form-field appearance="outline">
                    <mat-label>Swift Code</mat-label>
                    <input disabled [(ngModel)]="selectedAdvanceItem.swiftCode" matInput type="text"
                      placeholder="enter here...">
                  </mat-form-field>
                </div>
                <div class="col-md-12">
                  <mat-form-field appearance="outline">
                    <mat-label>Special Payment Instruction</mat-label>
                    <input disabled [(ngModel)]="selectedAdvanceItem.specialPaymentInstruction" matInput type="text"
                      placeholder="enter here...">
                  </mat-form-field>
                </div>
              </div>
              <div class="pr-3 pl-3 mt-3">
                <div class="row d-flex align-items-center header-box">
                  <div class="col-md-6 heading-contain">
                    <span>Title</span>
                  </div>
                  <div class="col-md-6 heading-contain">
                    <span>Amount</span>
                  </div>
                </div>
              </div>
              <div class="pr-3 pl-3" *ngIf="selectedRequest?.initialAdvance.data">
                <div class="row d-flex cost-box align-items-center mt-2" *ngFor="let item of apiCosts; let i = index;">
                  <div class="col-md-6">
                    <span>{{item.title}}</span>
                  </div>
                  <div class="col-md-6">
                    <span>{{item.amount | number}}</span>
                  </div>
                </div>
              </div>
              <div class="mt-2 pr-3 pl-3">
                <div class="row d-flex align-items-center header-box">
                  <div class="col-md-6 heading-contain">
                    <span class="pl-2">Total</span>
                  </div>
                  <div class="col-md-6 heading-contain">
                    <span *ngIf="selectedRequest !== null" class="pl-2">
                      {{selectedRequest.initialAdvance.amount | number}}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>
          <!-- TOOL BOX FOR PROCESS OWNER DISBURSEMENT -->
          <div class="col-md-5">
            <ng-container *ngIf="selectedRequest?.assigned">
              <div class="d-flex flex-column flex-fill">
                <div class="d-flex align-items-center heading-contain header-box">
                  <mat-icon>
                    settings_applications
                  </mat-icon>
                  <span class="pl-2">
                    Toolbox
                  </span>
                </div>
                <mat-form-field appearance="outline" class="mt-2">
                  <mat-label>Select User(s) For Reviews</mat-label>
                  <mat-select matNativeControl [compareWith]="compareSmeObjects" [formControl]="reviewUsers" multiple>
                    <mat-form-field class="p-3 filter-input" appearance="outline">
                      <mat-label>Filter By Department</mat-label>
                      <input matInput type="text" placeholder="Enter keyword..." [(ngModel)]="filterQuery">
                    </mat-form-field>
                    <mat-select-trigger>
                      <span *ngFor="let item of reviewUsers.value; let i=index">
                        <span *ngIf="i===0">{{item.name}}</span>
                      </span>
                      <span *ngIf="reviewUsers.value?.length > 1">
                        (+{{reviewUsers.value.length - 1}} others)
                      </span>
                    </mat-select-trigger>
                    <mat-optgroup *ngFor="let user of allUsers | depUserFilter:filterQuery" [label]="user.name">
                      <mat-option [hidden]="loggedUser.id === item.id || checkDisabled(item)"
                        *ngFor="let item of user.users" [value]="item">
                        {{item.name}}
                      </mat-option>
                    </mat-optgroup>
                  </mat-select>
                </mat-form-field>
                <button [disabled]="!reviewUsers.valid"
                  class="d-flex flex-fill justify-content-center align-items-center mt-2 mb-2" mat-raised-button
                  color="primary" (click)="assignUsersForReviews('initial')">
                  Assign For Reviews
                </button>

                <mat-chip-list *ngIf="initialAdvanceStats !== null" class="review-chip">
                  <mat-chip (click)="getReviewsList(selectedRequest.initialAdvance.initialAdvanceReviewsList);"
                    *ngIf="initialAdvanceStats.pendingCount !== 0" class="mt-2" color="warn" selected>
                    {{initialAdvanceStats.pendingCount}} Reviews Pending
                  </mat-chip>
                  <mat-chip (click)="getReviewsList(selectedRequest.initialAdvance.initialAdvanceReviewsList);"
                    *ngIf="initialAdvanceStats.completedCount !== 0" class="mt-2" color="accent" selected>
                    {{initialAdvanceStats.completedCount}} Reviews Submitted
                  </mat-chip>
                </mat-chip-list>
              </div>

            </ng-container>

            <!-- SUBMIT YOUR REVIEW -->
            <ng-container>
              <div *ngIf="selectedRequest !== null">
                <div *ngFor="let item of selectedRequest.initialAdvance.initialAdvanceReviewsList">
                  <div *ngIf="item.assignee.id === loggedUser.id">
                    <p>{{item.assignee.name}} please submit your review</p>
                    <mat-form-field appearance="outline">
                      <mat-label>Your Reviews</mat-label>
                      <textarea [disabled]="item.status === 'Completed'" placeholder="Enter text here..."
                        [(ngModel)]="item.comments" matInput cols="30" rows="10"></textarea>
                    </mat-form-field>
                    <mat-radio-group class="mt-2 example-radio-group" [disabled]="item.status === 'Completed'"
                      [(ngModel)]="item.subStatus">
                      <mat-radio-button class="example-radio-button" value="Approve">
                        <span id="comment">{{'Approved' | uppercase}}</span>
                      </mat-radio-button>
                      <mat-radio-button class="example-radio-button" value="Reject">
                        <span id="warn-comment">{{'Rejected' | uppercase}}</span>
                      </mat-radio-button>
                    </mat-radio-group>
                    <div class="mb-2 d-flex justify-content-end">
                      <button color="primary" (click)="submitReview(item)"
                        [disabled]="!item.comments || item.status === 'Completed'" mat-raised-button>
                        Submit
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </ng-container>

          </div>
        </div>

        <!-- ASSIGNED REVIEWS LIST -->
        <ng-container *ngIf="selectedRequest?.assigned">
          <div class="row mt-5" *ngIf="currentReviewsList && currentReviewsList.length !== 0">
            <div class="d-flex flex-fill align-items-center heading-contain header-box">
              <mat-icon>
                settings_applications
              </mat-icon>
              <span class="pl-2">
                Reviews History
              </span>
              <div class="example-spacer">
              </div>
              <mat-icon style="cursor: pointer;" class="ml-2" (click)="currentReviewsList = [];">
                disabled_by_default
              </mat-icon>
            </div>
          </div>
          <div class="row">
            <div class="col-md-12 d-flex cost-box align-items-center mt-2"
              *ngFor="let item of currentReviewsList; let i = index;">
              <div class="col-md-3">
                <span>{{item.assignee.name}}</span>
              </div>
              <div class="col-md-3">
                <span id="warn-comment" *ngIf="item.status === 'Pending'">{{item.status}}</span>
                <span id="comment" *ngIf="item.status === 'Completed'">{{item.status}}</span>
              </div>
              <div class="col-md-6">
                <span>{{item.comments}}</span>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- LIQUIDATION FOR ADVANCE -->
        <div class="border-heading mt-5" *ngIf="selectedAdvanceItem?.subStatus === 'Approved'">
          <span>Advance Liquidation</span>
        </div>

        <!-- LIQUIDATION PRINT BOX -->
        <div class="row mb-2" *ngIf="selectedAdvanceItem?.subStatus === 'Approved'">
          <div class="col-md-12 mb-3">
            <div class="d-flex flex-fill justify-content-between align-items-center">
              <div class="d-flex align-items-center" style="width: 33%;">
                <span
                  style="text-align:center;border: 1px solid;padding: 2px 10px;margin-right:10px;width:15%;">&nbsp;</span>
                <span>Initial Advance</span>
              </div>
              <div class="d-flex align-items-center" style="width: 33%;">
                <span
                  style="text-align:center;border: 1px solid;padding: 2px 10px;margin-right:10px;width:15%;">X</span>
                <span>Liquidation Only</span>
              </div>
              <div class="d-flex align-items-center" style="width: 33%;">
                <span
                  style="text-align:center;border: 1px solid;padding: 2px 10px;margin-right:10px;width:15%;">&nbsp;</span>
                <span>Liquidation & Replenishment</span>
              </div>
            </div>
          </div>
          <div class="col-md-12 mb-3">
            <div class="d-flex flex-fill justify-content-between align-items-center">
              <div class="d-flex align-items-center" style="width: 33%;">
                <span
                  style="text-align:center;border: 1px solid;padding: 2px 10px;margin-right:10px;width:15%;">&nbsp;</span>
                <span>Advance</span>
              </div>
              <div class="d-flex align-items-center" style="width: 33%;">
                <span
                  style="text-align:center;border: 1px solid;padding: 2px 10px;margin-right:10px;width:15%;">&nbsp;</span>
                <span>Replenishment</span>
              </div>
              <div class="d-flex align-items-center" style="width: 33%;">
                <span
                  style="text-align:center;border: 1px solid;padding: 2px 10px;margin-right:10px;width:15%;">&nbsp;</span>
                <span>Direct Payment</span>
              </div>
            </div>
          </div>
        </div>

        <!-- LIQUIDATION EXTRA FROM FIELDS -->
        <div class="row mt-3 mb-3"
          *ngIf="selectedAdvanceLiquidation !== null && selectedAdvanceItem?.subStatus === 'Approved'">
          <div class="col-md-12">
            <mat-form-field appearance="outline">
              <mat-label>Payees Name</mat-label>
              <input [disabled]="loggedUser.role !== 'fip' 
              || selectedAdvanceLiquidation?.status !== 'Not Initiated'"
                [(ngModel)]="selectedAdvanceLiquidation.payeesName" matInput type="text" placeholder="enter here...">
            </mat-form-field>
          </div>
          <div class="col-md-12">
            <mat-form-field appearance="outline">
              <mat-label>Payees Address</mat-label>
              <input [disabled]="loggedUser.role !== 'fip' 
              || selectedAdvanceLiquidation?.status !== 'Not Initiated'"
                [(ngModel)]="selectedAdvanceLiquidation.payeesAddress" matInput type="text" placeholder="enter here...">
            </mat-form-field>
          </div>
          <div class="col-md-12">
            <mat-form-field appearance="outline">
              <mat-label>Bank Name</mat-label>
              <input [disabled]="loggedUser.role !== 'fip' 
              || selectedAdvanceLiquidation?.status !== 'Not Initiated'"
                [(ngModel)]="selectedAdvanceLiquidation.bankName" matInput type="text" placeholder="enter here...">
            </mat-form-field>
          </div>
          <div class="col-md-12">
            <mat-form-field appearance="outline">
              <mat-label>Bank Address</mat-label>
              <input [disabled]="loggedUser.role !== 'fip' 
              || selectedAdvanceLiquidation?.status !== 'Not Initiated'"
                [(ngModel)]="selectedAdvanceLiquidation.bankAddress" matInput type="text" placeholder="enter here...">
            </mat-form-field>
          </div>
          <div class="col-md-6">
            <mat-form-field appearance="outline">
              <mat-label>Payees Account #</mat-label>
              <input [disabled]="loggedUser.role !== 'fip' 
              || selectedAdvanceLiquidation?.status !== 'Not Initiated'"
                [(ngModel)]="selectedAdvanceLiquidation.payeesAccount" matInput type="text" placeholder="enter here...">
            </mat-form-field>
          </div>
          <div class="col-md-6">
            <mat-form-field appearance="outline">
              <mat-label>Swift Code</mat-label>
              <input [disabled]="loggedUser.role !== 'fip' 
              || selectedAdvanceLiquidation?.status !== 'Not Initiated'"
                [(ngModel)]="selectedAdvanceLiquidation.swiftCode" matInput type="text" placeholder="enter here...">
            </mat-form-field>
          </div>
          <div class="col-md-12">
            <mat-form-field appearance="outline">
              <mat-label>Special Payment Instruction</mat-label>
              <input [disabled]="loggedUser.role !== 'fip' 
              || selectedAdvanceLiquidation?.status !== 'Not Initiated'"
                [(ngModel)]="selectedAdvanceLiquidation.specialPaymentInstruction" matInput type="text"
                placeholder="enter here...">
            </mat-form-field>
          </div>
        </div>

        <!-- BUDGET UTILIZATION NDRMF -->
        <div *ngIf="selectedAdvanceItem?.subStatus === 'Approved'" class="mb-3">
          <p id="answer" class="p-2">Summary Budget Utilization (NDRMF Share)</p>
          <div class="d-flex align-items-center justify-content-between rag-div table-header">
            <span>
              Parent Tree
            </span>
            <span>
              Budget Category
            </span>
            <span>
              Total Project Budget Allocation (c)
            </span>
            <span>
              Expenditure upto last quarter (d)
            </span>
            <span>
              Expenditure for the current quarter (e)
            </span>
            <span>
              Expenditure till date (f = d+e)
            </span>
            <span>
              Remaining Budget (g = c-f)
            </span>
            <!-- <span>
              Remarks
            </span> -->
          </div>

          <div *ngFor="let item of selectedAdvanceLiquidation?.data; let i = index;">
            <div class="d-flex rag-div justify-content-between align-items-center table-row">
              <span>
                <div *ngIf="item?.parentCosts">
                  <div *ngFor="let _ of item?.parentCosts; let i = index">
                    <ng-container *ngIf="item?.parentCosts[item?.parentCosts.length-i-1] as name">
                      <small>{{name}}</small>
                      <small id="comment">{{i !== (item?.parentCosts.length - 1) ? ' ->' : '&nbsp;'}}</small>
                    </ng-container>
                  </div>
                </div>
              </span>
              <span>{{item.title}}</span>
              <span>{{getNdrmfTotalBudgetAllocation(item) | number}}</span>
              <span>{{'&nbsp;'}}</span>
              <span>{{getNdrmfExpenditureCurrentQuarter(item, 'initial') | number}}</span>
              <span>{{(0 + getNdrmfExpenditureCurrentQuarter(item, 'initial')) | number}}</span>
              <span>{{(getNdrmfTotalBudgetAllocation(item) - getNdrmfExpenditureCurrentQuarter(item, 'initial')) |
                number}}</span>
              <!-- <span>&nbsp;</span> -->
            </div>
          </div>

        </div>

        <!-- SUMMARY SOEs NDRMF -->
        <div *ngIf="selectedAdvanceItem?.subStatus === 'Approved'" class="mb-3">
          <p id="answer" class="p-2">Summary of SOE (NDRMF Share)</p>
          <div class="d-flex align-items-center justify-content-between rag-div table-header">
            <span>
              Parent Tree
            </span>
            <span>
              Budget Category
            </span>
            <span>
              Quarter Budget Allocation (c)
            </span>
            <span>
              Quarter Expenditure (SOE) (d)
            </span>
            <span>
              Variance - favorable / unfavorable (e = c - d)
            </span>
            <span>
              % Variance
            </span>
            <!-- <span>
              Remarks
            </span> -->
          </div>

          <div *ngFor="let item of selectedAdvanceLiquidation?.data; let i = index;">
            <div class="d-flex rag-div justify-content-between align-items-center table-row">
              <span>
                <div *ngIf="item?.parentCosts">
                  <div *ngFor="let _ of item?.parentCosts; let i = index">
                    <ng-container *ngIf="item?.parentCosts[item?.parentCosts.length-i-1] as name">
                      <small>{{name}}</small>
                      <small id="comment">{{i !== (item?.parentCosts.length - 1) ? ' ->' : '&nbsp;'}}</small>
                    </ng-container>
                  </div>
                </div>
              </span>
              <span>{{item.title}}</span>
              <span>{{getNdrmfQuarterBudgetAllocation(item) | number}}</span>
              <span>{{getNdrmfExpenditureCurrentQuarter(item, 'initial') | number}}</span>
              <span>{{(getNdrmfQuarterBudgetAllocation(item) - getNdrmfExpenditureCurrentQuarter(item, 'initial')) |
                number}}</span>
              <span>{{'&nbsp;'}}</span>
              <!-- <span>{{'&nbsp;'}}</span> -->
            </div>
          </div>

        </div>

        <!-- NDRMF SOEs -->
        <div class="mb-3" *ngIf="selectedAdvanceItem?.subStatus === 'Approved'">
          <div class="d-flex justify-content-between mt-2 mb-2">
            <p id="answer" class="p-2">SOEs for NDRMF</p>
            <!-- <button mat-mini-fab color="accent" (click)="addNdrmfSoes();">
                                  <mat-icon>add</mat-icon>
                                </button> -->
          </div>
          <div class="table-header rag-div d-flex align-items-center">
            <span class="p-2">Categories</span>
            <span class="p-2">Vendor Name</span>
            <span class="p-2">Invoice amount</span>
            <span class="p-2">Date of Payment</span>
            <span class="p-2">Paid Amount</span>
            <span class="p-2">Cheque #</span>
            <span class="p-2">Remarks</span>
          </div>

          <div>
            <div *ngFor="let item of ndrmfLiquidationSoes; let i = index;">
              <div class="d-flex rag-div justify-content-between align-items-center table-row">
                <span class="">
                  <mat-form-field appearance="outline">
                    <mat-label>Select Activity</mat-label>
                    <mat-select [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')" matNativeControl [(ngModel)]="item.activityId">
                      <mat-option *ngFor="let obj of selectedAdvanceLiquidation?.data" [value]="obj._id">{{obj.title
                        | titlecase}}</mat-option>
                    </mat-select>
                  </mat-form-field>
                </span>
                <span class="">
                  <mat-form-field appearance="outline">
                    <mat-label>Vendor Name</mat-label>
                    <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')" type="text" [(ngModel)]="item.vendorName"
                      placeholder="enter here..." matInput>
                  </mat-form-field>
                </span>
                <span class="">
                  <mat-form-field appearance="outline">
                    <mat-label>Total Bill / Invoice amount</mat-label>
                    <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')" type="number" [(ngModel)]="item.invoiceAmount"
                      placeholder="enter here..." matInput>
                  </mat-form-field>
                </span>
                <span class="">
                  <mat-form-field appearance="outline"
                    *ngIf="loggedUser.role === 'fip' || (selectedAdvanceLiquidation?.status === 'Re Assigned' ||
                                                        selectedAdvanceLiquidation?.status === 'Not Initiated') || item.dateOfPayment === null">
                    <mat-label>Date of Payment</mat-label>
                    <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                                    selectedAdvanceLiquidation?.status === 'Under Review')" matInput
                      [matDatepicker]="picker" [(ngModel)]="item.dateOfPayment">
                    <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                    <mat-datepicker #picker></mat-datepicker>
                  </mat-form-field>
                  <small id="date-field" *ngIf="loggedUser.role !== 'fip' && item.dateOfPayment !== null">
                    {{item.dateOfPayment |
                    date:'shortDate'}}</small>
                </span>
                <span class="">
                  <mat-form-field appearance="outline">
                    <mat-label>Paid Amount</mat-label>
                    <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')" type="number" [(ngModel)]="item.paidAmount"
                      placeholder="enter here..." matInput>
                  </mat-form-field>
                </span>
                <span class="">
                  <mat-form-field appearance="outline">
                    <mat-label>Cheque #</mat-label>
                    <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')" type="text" [(ngModel)]="item.chequeNumber"
                      placeholder="enter here..." matInput>
                  </mat-form-field>
                </span>
                <span class="">
                  <mat-form-field appearance="outline">
                    <mat-label>Remarks</mat-label>
                    <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')" type="text" [(ngModel)]="item.remarks"
                      placeholder="enter here..." matInput>
                  </mat-form-field>
                </span>
              </div>
            </div>
          </div>
          <div class="d-flex justify-content-end mt-2 mb-2" *ngIf="loggedUser?.role === 'fip'">
            <button [disabled]="selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review'" mat-flat-button color="accent"
              (click)="addNdrmfSoes();">
              <mat-icon>add</mat-icon> Add SOE
            </button>
          </div>

        </div>


        <!-- SUMMARY SOEs FIP -->
        <div *ngIf="selectedAdvanceItem?.subStatus === 'Approved'" class="mb-3">
          <p id="answer" class="p-2">Summary Budget Utilization (FIP Share)</p>
          <div class="d-flex align-items-center justify-content-between rag-div table-header">
            <span>
              Parent Tree
            </span>
            <span>
              Budget Category
            </span>
            <span>
              Total Project Budget Allocation (c)
            </span>
            <span>
              Expenditure upto last quarter (d)
            </span>
            <span>
              Expenditure for the current quarter (e)
            </span>
            <span>
              Expenditure till date (f = d+e)
            </span>
            <span>
              Remaining Budget (g = c-f)
            </span>
            <!-- <span>
              Remarks
            </span> -->
          </div>

          <div *ngFor="let item of selectedAdvanceLiquidation?.data; let i = index;">
            <div class="d-flex rag-div justify-content-between align-items-center table-row">
              <span>
                <div *ngIf="item?.parentCosts">
                  <div *ngFor="let _ of item?.parentCosts; let i = index">
                    <ng-container *ngIf="item?.parentCosts[item?.parentCosts.length-i-1] as name">
                      <small>{{name}}</small>
                      <small id="comment">{{i !== (item?.parentCosts.length - 1) ? ' ->' : '&nbsp;'}}</small>
                    </ng-container>
                  </div>
                </div>
              </span>
              <span>{{item.title}}</span>
              <span>{{getFipTotalBudgetAllocation(item) | number}}</span>
              <span>{{'&nbsp;'}}</span>
              <span>{{getFipExpenditureCurrentQuarter(item) | number}}</span>
              <span>{{(0 + getFipExpenditureCurrentQuarter(item)) | number}}</span>
              <span>{{(getFipTotalBudgetAllocation(item) - getFipExpenditureCurrentQuarter(item)) | number}}</span>
              <!-- <span>&nbsp;</span> -->
            </div>
          </div>

        </div>

        <!-- SUMMARY SOEs FIP -->
        <div *ngIf="selectedAdvanceItem?.subStatus === 'Approved'" class="mb-3">
          <p id="answer" class="p-2">Summary of SOE (FIP Share)</p>
          <div class="d-flex align-items-center justify-content-between rag-div table-header">
            <span>
              Parent Tree
            </span>
            <span>
              Budget Category
            </span>
            <span>
              Quarter Budget Allocation (c)
            </span>
            <span>
              Quarter Expenditure (SOE) (d)
            </span>
            <span>
              Variance - favorable / unfavorable (e = c - d)
            </span>
            <span>
              % Variance
            </span>
            <!-- <span>
              Remarks
            </span> -->
          </div>

          <div *ngFor="let item of selectedAdvanceLiquidation?.data; let i = index;">
            <div class="d-flex rag-div justify-content-between align-items-center table-row">
              <span>
                <div *ngIf="item?.parentCosts">
                  <div *ngFor="let _ of item?.parentCosts; let i = index">
                    <ng-container *ngIf="item?.parentCosts[item?.parentCosts.length-i-1] as name">
                      <small>{{name}}</small>
                      <small id="comment">{{i !== (item?.parentCosts.length - 1) ? ' ->' : '&nbsp;'}}</small>
                    </ng-container>
                  </div>
                </div>
              </span>
              <span>{{item.title}}</span>
              <span>{{getFipQuarterBudgetAllocation(item) | number}}</span>
              <span>{{getFipExpenditureCurrentQuarter(item) | number}}</span>
              <span>{{(getFipQuarterBudgetAllocation(item) - getFipExpenditureCurrentQuarter(item)) |
                number}}</span>
              <span>{{'&nbsp;'}}</span>
              <!-- <span>{{'&nbsp;'}}</span> -->
            </div>
          </div>

        </div>

        <!-- FIP SOEs -->
        <ng-container *ngIf="selectedAdvanceItem?.subStatus === 'Approved'">
          <div class="mb-3">
            <div class="d-flex justify-content-between mt-2 mb-2">
              <p id="answer" class="p-2">SOEs for FIP</p>
              <!-- <button mat-mini-fab color="accent" (click)="addFipSoes();">
                <mat-icon>add</mat-icon>
              </button> -->
            </div>
            <div class="table-header rag-div d-flex align-items-center">
              <span class="p-2">Categories</span>
              <span class="p-2">Vendor Name</span>
              <span class="p-2">Invoice amount</span>
              <span class="p-2">Date of Payment</span>
              <span class="p-2">Paid Amount</span>
              <span class="p-2">Cheque #</span>
              <span class="p-2">Remarks</span>
            </div>

            <div>
              <div *ngFor="let item of fipLiquidationSoes; let i = index;">
                <div class="d-flex rag-div justify-content-between align-items-center table-row">
                  <span class="">
                    <mat-form-field appearance="outline">
                      <mat-label>Select Activity</mat-label>
                      <mat-select [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')" matNativeControl [(ngModel)]="item.activityId">
                        <mat-option *ngFor="let obj of selectedAdvanceLiquidation?.data" [value]="obj._id">{{obj.title
                          | titlecase}}</mat-option>
                      </mat-select>
                    </mat-form-field>
                  </span>
                  <span class="">
                    <mat-form-field appearance="outline">
                      <mat-label>Vendor Name</mat-label>
                      <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')" type="text" [(ngModel)]="item.vendorName"
                        placeholder="enter here..." matInput>
                    </mat-form-field>
                  </span>
                  <span class="">
                    <mat-form-field appearance="outline">
                      <mat-label>Total Bill / Invoice amount</mat-label>
                      <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')" type="text" [(ngModel)]="item.invoiceAmount"
                        placeholder="enter here..." matInput>
                    </mat-form-field>
                  </span>
                  <span class="">
                    <mat-form-field appearance="outline"
                      *ngIf="loggedUser.role === 'fip' || (selectedAdvanceLiquidation?.status === 'Re Assigned' ||
                                                        selectedAdvanceLiquidation?.status === 'Not Initiated') || item.dateOfPayment === null">
                      <mat-label>Date of Payment</mat-label>
                      <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                                    selectedAdvanceLiquidation?.status === 'Under Review')" matInput
                        [matDatepicker]="picker2" [(ngModel)]="item.dateOfPayment">
                      <mat-datepicker-toggle matSuffix [for]="picker2"></mat-datepicker-toggle>
                      <mat-datepicker #picker2></mat-datepicker>
                    </mat-form-field>
                    <small id="date-field" *ngIf="loggedUser.role !== 'fip' && item.dateOfPayment !== null">
                      {{item.dateOfPayment |
                      date:'shortDate'}}</small>
                  </span>
                  <span class="">
                    <mat-form-field appearance="outline">
                      <mat-label>Paid Amount</mat-label>
                      <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')" type="text" [(ngModel)]="item.paidAmount"
                        placeholder="enter here..." matInput>
                    </mat-form-field>
                  </span>
                  <span class="">
                    <mat-form-field appearance="outline">
                      <mat-label>Cheque #</mat-label>
                      <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')" type="text" [(ngModel)]="item.chequeNumber"
                        placeholder="enter here..." matInput>
                    </mat-form-field>
                  </span>
                  <span class="">
                    <mat-form-field appearance="outline">
                      <mat-label>Remarks</mat-label>
                      <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')" type="text" [(ngModel)]="item.remarks"
                        placeholder="enter here..." matInput>
                    </mat-form-field>
                  </span>
                </div>
              </div>
            </div>

            <div class="d-flex justify-content-end mt-2 mb-2" *ngIf="loggedUser?.role === 'fip'">

              <button [disabled]="selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review'" mat-flat-button color="accent"
                (click)="addFipSoes();">
                <mat-icon>add</mat-icon> Add SOE
              </button>
            </div>

          </div>
        </ng-container>


        <mat-action-row>
          <div *ngIf="loggedUser?.role === 'fip'" class="d-flex align-items-center flex-fill justify-content-between">
            <div class="d-flex flex-column">
              <div class="mb-2">
                <span id="answer">Advance Status:</span>
                {{selectedRequest?.initialAdvance.status}}
              </div>
              <div>
                <span id="answer">Liquidation Status:</span>
                {{selectedAdvanceLiquidation?.status}}
              </div>
            </div>
            <div class="d-flex flex-column">
              <button class="mb-2" [disabled]="apiCosts === null || 
            (selectedAdvanceItem?.status === 'Approved' || 
                  selectedAdvanceItem?.status === 'Completed' ||
                  selectedAdvanceItem?.status === 'Under Review' ||
                  selectedAdvanceItem?.status === 'Review Pending' ||
                  selectedAdvanceItem?.status === 'Review Completed' ||
                  selectedAdvanceItem?.status === 'Marked To PO' ||
                  selectedAdvanceItem?.subStatus === 'Approved') || approveLoading" mat-raised-button color="accent"
                (click)="submitInitalAdvance();">Submit Initial Advance</button>
              <div>
                <button *ngIf="!approveLoading && selectedAdvanceItem?.subStatus === 'Approved'"
                  [disabled]="(selectedAdvanceLiquidation?.status === 'Approved' ||
                              selectedAdvanceLiquidation?.status === 'Under Review' || selectedAdvanceItem?.status === 'Re Assigned')" mat-raised-button color="accent"
                  (click)="submitAdvanceLiquidation()">
                  {{ (selectedAdvanceItem?.status === null ||
                  selectedAdvanceLiquidation?.status === 'Not Initiated') ?
                  'Submit Quarter Liquidation' : 'Update Quarter Liquidation'}}
                </button>
                <mat-progress-spinner *ngIf="approveLoading" mode="indeterminate" diameter="20"></mat-progress-spinner>
              </div>
            </div>
          </div>
          <div *ngIf="selectedRequest?.assigned" class="d-flex align-items-center flex-fill justify-content-between">
            <div class="d-flex flex-column">
              <div class="mb-2">
                <span id="answer">Advance Status:</span>
                {{selectedRequest?.initialAdvance.status}}
              </div>
              <div>
                <span id="answer">Liquidation Status:</span>
                {{selectedAdvanceLiquidation?.status}}
              </div>
            </div>
            <div class="d-flex flex-column">
              <button [disabled]="selectedAdvanceItem?.status === 'Re Assigned' || approveLoading" class="mb-2" (click)="(selectedRequest?.initialAdvance.subStatus === null ||
                                selectedRequest?.initialAdvance.subStatus === 'Pending') ?
                                approveInitialAdvance(selectedRequest, 'Approve Advance') : 
                                rejectInitialAdvance(selectedRequest, 'Reject Advance')" [color]="(selectedRequest?.initialAdvance.subStatus === null ||
                                selectedRequest?.initialAdvance.subStatus === 'Pending') ?
                                'accent' : 'warn'" mat-raised-button>
                {{(selectedRequest?.initialAdvance.subStatus === null ||
                selectedRequest?.initialAdvance.subStatus === 'Pending') ?
                'Approve Initial Advance' : 'Reject Initial Advance'}}
              </button>
              <button class="mb-2" [disabled]="(selectedAdvanceItem?.status === 'Re Assigned') || approveLoading"
                color="accent" mat-raised-button (click)="reassignInitialAdvance(selectedRequest)">
                {{'Re-assign Initial Advance'}}
              </button>
              <div class="mb-2">
                <mat-divider></mat-divider>
              </div>
              <button class="mb-2" [disabled]="selectedAdvanceLiquidation?.status === 'Not Initiated' ||
                             selectedAdvanceLiquidation?.status === 'Approved' || selectedAdvanceLiquidation?.status === 'Re Assigned'
                             || approveLoading || selectedAdvanceItem?.data === null || 
                             selectedAdvanceLiquidation === null || selectedAdvanceItem?.status === 'Re Assigned'
                             || selectedAdvanceItem?.status === 'Completed'" mat-raised-button color="accent"
                (click)="approveQuarterLiquidation()">
                Approve Advance Liquidation
              </button>
              <button [disabled]="selectedAdvanceLiquidation?.status === 'Re Assigned' || 
                            selectedAdvanceLiquidation?.status === 'Not Initiated' || approveLoading || 
                            selectedAdvanceLiquidation === null || selectedAdvanceItem?.status === 'Re Assigned'
                            || selectedAdvanceItem?.status === 'Completed'" mat-raised-button color="accent"
                (click)="reassignQuarterLiquidation()">
                Reassign Advance Liquidation
              </button>
            </div>
          </div>
        </mat-action-row>

      </mat-expansion-panel>
    </mat-accordion>
  </ng-container>

  <!-- QUARTER ADVANCES -->
  <div class="box-heading">
    <span class="pl-0">Quarter Advance(s)</span>
  </div>
  <ng-container>
    <mat-accordion class="example-headers-align" multi>
      <mat-expansion-panel *ngFor="let item of selectedRequest?.quarterAdvanceList; let i = index;"
        [expanded]="step === i" (opened)="setStep(item, i, 'quarter')">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <span class="responsive-text">Quarter Advance #{{i+2}}</span>
          </mat-panel-title>
          <mat-panel-description>
            <span id="comment" class="responsive-text">
              {{item.status ?
              item.status : '&nbsp;' }}
            </span>
            <span id="answer" class="responsive-text">
              {{item.subStatus ?
              item.subStatus : '&nbsp;' }}
            </span>
            <mat-icon>
              unfold_more
            </mat-icon>
          </mat-panel-description>
        </mat-expansion-panel-header>



        <!-- TOP FORM FIELDS -->
        <ng-container *ngIf="loggedUser?.role === 'fip'">

          <div class="row">
            <div class="col-md-12 mb-3">
              <div class="d-flex flex-fill justify-content-between align-items-center">
                <div class="d-flex align-items-center" style="width: 33%;">
                  <span
                    style="text-align: center;border: 1px solid;padding: 5px 0px;margin-right:10px;width:15%;">&nbsp;</span>
                  <span>Initial Advance</span>
                </div>
                <div class="d-flex align-items-center" style="width: 33%;">
                  <span
                    style="text-align: center;border: 1px solid;padding: 5px 0px;margin-right:10px;width:15%;">&nbsp;</span>
                  <span>Liquidation Only</span>
                </div>
                <div class="d-flex align-items-center" style="width: 33%;">
                  <span
                    style="text-align: center;border: 1px solid;padding: 5px 0px;margin-right:10px;width:15%;">&nbsp;</span>
                  <span>Liquidation & Replenishment</span>
                </div>
              </div>
            </div>
            <div class="col-md-12 mb-3">
              <div class="d-flex flex-fill justify-content-between align-items-center">
                <div class="d-flex align-items-center" style="width: 33%;">
                  <span
                    style="text-align: center;border: 1px solid;padding: 5px 0px;margin-right:10px;width:15%;">X</span>
                  <span>Advance</span>
                </div>
                <div class="d-flex align-items-center" style="width: 33%;">
                  <span
                    style="text-align: center;border: 1px solid;padding: 5px 0px;margin-right:10px;width:15%;">&nbsp;</span>
                  <span>Replenishment</span>
                </div>
                <div class="d-flex align-items-center" style="width: 33%;">
                  <span
                    style="text-align: center;border: 1px solid;padding: 5px 0px;margin-right:10px;width:15%;">&nbsp;</span>
                  <span>Direct Payment</span>
                </div>
              </div>
            </div>
          </div>

          <!-- FORM FOR ADVANCE EXTRA FIELDS -->
          <form [formGroup]="advanceForm">
            <div class="row">
              <div class="col-md-12">
                <mat-form-field appearance="outline">
                  <mat-label>Payees Name</mat-label>
                  <input formControlName="payeesName" matInput type="text" placeholder="enter here...">
                </mat-form-field>
              </div>
              <div class="col-md-12">
                <mat-form-field appearance="outline">
                  <mat-label>Payees Address</mat-label>
                  <input formControlName="payeesAddress" matInput type="text" placeholder="enter here...">
                </mat-form-field>
              </div>
              <div class="col-md-12">
                <mat-form-field appearance="outline">
                  <mat-label>Bank Name</mat-label>
                  <input formControlName="bankName" matInput type="text" placeholder="enter here...">
                </mat-form-field>
              </div>
              <div class="col-md-12">
                <mat-form-field appearance="outline">
                  <mat-label>Bank Address</mat-label>
                  <input formControlName="bankAddress" matInput type="text" placeholder="enter here...">
                </mat-form-field>
              </div>
              <div class="col-md-6">
                <mat-form-field appearance="outline">
                  <mat-label>Payees Account #</mat-label>
                  <input formControlName="payeesAccount" matInput type="text" placeholder="enter here...">
                </mat-form-field>
              </div>
              <div class="col-md-6">
                <mat-form-field appearance="outline">
                  <mat-label>Swift Code</mat-label>
                  <input formControlName="swiftCode" matInput type="text" placeholder="enter here...">
                </mat-form-field>
              </div>
              <div class="col-md-12">
                <mat-form-field appearance="outline">
                  <mat-label>Special Payment Instruction</mat-label>
                  <input formControlName="specialPaymentInstruction" matInput type="text" placeholder="enter here...">
                </mat-form-field>
              </div>
            </div>
          </form>


          <!-- SELECT COSTS FORM FIELD -->
          <div class="row d-flex align-items-center mb-3">
            <div class="col-md-9">

              <mat-form-field appearance="outline" *ngIf="selectedRequest?.quarterAdvanceList[step]?.data === null">
                <mat-label>Select Cost(s)</mat-label>
                <mat-select matNativeControl [formControl]="costsData" multiple>
                  <!-- OPTIONS FILTER -->
                  <mat-form-field class="p-3 filter-input"
                    *ngIf="selectedRequest?.quarterAdvanceList[step]?.data === null" appearance="outline">
                    <mat-label>Filter</mat-label>
                    <input matInput type="text" placeholder="Enter keyword..." [(ngModel)]="filterQuery">
                  </mat-form-field>
                  <mat-select-trigger>
                    <div *ngIf="costsData && costsData?.value?.length">
                      <span *ngFor="let item of costsData.value; let i=index">
                        <span *ngIf="i===0">{{item.title}}</span>
                      </span>
                      <span *ngIf="costsData.value?.length > 1">
                        (+{{costsData.value.length - 1}} others)
                      </span>
                    </div>
                  </mat-select-trigger>
                  <mat-option *ngFor="let item of costSelections | costsFilter:filterQuery" [value]="item">{{item.title
                    | titlecase}}</mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline" *ngIf="selectedRequest?.quarterAdvanceList[step]?.data !== null">
                <mat-label>Select Cost</mat-label>
                <mat-select matNativeControl [formControl]="costsData">
                  <!-- OPTIONS FILTER -->
                  <mat-form-field class="p-3 filter-input"
                    *ngIf="selectedRequest?.quarterAdvanceList[step]?.data !== null" appearance="outline">
                    <mat-label>Filter</mat-label>
                    <input matInput type="text" placeholder="Enter keyword..." [(ngModel)]="filterQuery">
                  </mat-form-field>
                  <mat-option *ngFor="let item of costSelections | costsFilter:filterQuery" [value]="item">{{item.title
                    | titlecase}}</mat-option>
                </mat-select>
              </mat-form-field>

            </div>
            <div class="col-md-2">
              <button [disabled]="selectedRequest.quarterAdvanceList[step]?.status === 'Approved' ||
              selectedRequest.quarterAdvanceList[step]?.status === 'Under Review' ||
              selectedRequest.quarterAdvanceList[step]?.status === 'Completed' || !costsData.valid" mat-raised-button
                color="primary" (click)="addQuarterData();">Add Costs</button>
            </div>
          </div>
        </ng-container>
        <!-- FIP SUBMITTED DATA TABLE -->
        <ng-container *ngIf="loggedUser?.role === 'fip' && selectedRequest?.quarterAdvanceList[step]?.data !== null">
          <div class="row d-flex align-items-center header-box">
            <div class="col-md-4 heading-contain">
              <span class="pl-2">Parent Tree</span>
            </div>
            <div class="col-md-4 heading-contain">
              <span class="pl-2">Title</span>
            </div>
            <div class="col-md-4 heading-contain">
              <span class="pl-2">Amount</span>
            </div>
          </div>
          <div *ngIf="selectedRequest !== null && selectedRequest.quarterAdvanceList[step]">
            <div class="row cost-box d-flex align-items-center mt-2"
              *ngFor="let item of selectedRequest.quarterAdvanceList[step].data; let i = index;">
              <div class="col-md-4">
                <span>
                  <div *ngIf="item?.parentCosts">
                    <div *ngFor="let _ of item?.parentCosts; let i = index">
                      <ng-container *ngIf="item?.parentCosts[item?.parentCosts.length-i-1] as name">
                        <small>{{name}}</small>
                        <small id="comment">{{i !== (item?.parentCosts.length - 1) ? ' ->' : '&nbsp;'}}</small>
                      </ng-container>
                    </div>
                  </div>
                </span>
              </div>
              <div class="col-md-4">
                <span>{{item.title}}</span>
              </div>
              <div class="col-md-4">
                <mat-form-field appearance="outline">
                  <mat-label>Amount</mat-label>
                  <input [disabled]="(selectedAdvanceItem?.status === 'Approved' || 
                  selectedAdvanceItem?.status === 'Under Review' ||
                  selectedAdvanceItem?.status === 'Completed' ||
                  selectedAdvanceItem?.status === 'Review Pending' ||
                  selectedAdvanceItem?.status === 'Review Completed' ||
                  selectedAdvanceItem?.status === 'Marked To PO' ||
                  selectedAdvanceItem?.subStatus === 'Approved')" matInput type="number" placeholder="Enter Amount..."
                    [(ngModel)]="item.amount">
                </mat-form-field>
              </div>
            </div>
          </div>
          <div class="d-flex justify-content-end">
            <button [disabled]="(selectedAdvanceItem?.status === 'Approved' || 
                  selectedAdvanceItem?.status === 'Completed' ||
                  selectedAdvanceItem?.status === 'Under Review' ||
                  selectedAdvanceItem?.status === 'Review Pending' ||
                  selectedAdvanceItem?.status === 'Review Completed' ||
                  selectedAdvanceItem?.status === 'Marked To PO' ||
                  selectedAdvanceItem?.subStatus === 'Approved') || approveLoading" color="accent" mat-raised-button
              class="mt-3" (click)="submitQuarterAdvance();">
              {{!approveLoading ? 'Submit Quarter Advance' : '&nbsp;'}}
              <mat-progress-spinner *ngIf="approveLoading" mode="indeterminate" diameter="20"></mat-progress-spinner>
            </button>
          </div>
        </ng-container>
        <!-- NOT FIP SUBMITTED DATA TABLE -->
        <ng-container *ngIf="loggedUser?.role !== 'fip'">
          <div class="row">
            <div class="col-md-12 mb-3">
              <div class="row" *ngIf="selectedAdvanceItem !== null">
                <div class="col-md-12">
                  <mat-form-field appearance="outline">
                    <mat-label>Payees Name</mat-label>
                    <input disabled [(ngModel)]="selectedAdvanceItem.payeesName" matInput type="text"
                      placeholder="enter here...">
                  </mat-form-field>
                </div>
                <div class="col-md-12">
                  <mat-form-field appearance="outline">
                    <mat-label>Payees Address</mat-label>
                    <input disabled [(ngModel)]="selectedAdvanceItem.payeesAddress" matInput type="text"
                      placeholder="enter here...">
                  </mat-form-field>
                </div>
                <div class="col-md-12">
                  <mat-form-field appearance="outline">
                    <mat-label>Bank Name</mat-label>
                    <input disabled [(ngModel)]="selectedAdvanceItem.bankName" matInput type="text"
                      placeholder="enter here...">
                  </mat-form-field>
                </div>
                <div class="col-md-12">
                  <mat-form-field appearance="outline">
                    <mat-label>Bank Address</mat-label>
                    <input disabled [(ngModel)]="selectedAdvanceItem.bankAddress" matInput type="text"
                      placeholder="enter here...">
                  </mat-form-field>
                </div>
                <div class="col-md-6">
                  <mat-form-field appearance="outline">
                    <mat-label>Payees Account #</mat-label>
                    <input disabled [(ngModel)]="selectedAdvanceItem.payeesAccount" matInput type="text"
                      placeholder="enter here...">
                  </mat-form-field>
                </div>
                <div class="col-md-6">
                  <mat-form-field appearance="outline">
                    <mat-label>Swift Code</mat-label>
                    <input disabled [(ngModel)]="selectedAdvanceItem.swiftCode" matInput type="text"
                      placeholder="enter here...">
                  </mat-form-field>
                </div>
                <div class="col-md-12">
                  <mat-form-field appearance="outline">
                    <mat-label>Special Payment Instruction</mat-label>
                    <input disabled [(ngModel)]="selectedAdvanceItem.specialPaymentInstruction" matInput type="text"
                      placeholder="enter here...">
                  </mat-form-field>
                </div>
              </div>
              <div class="p-3">
                <div class="row d-flex align-items-center header-box mt-2">
                  <div class="col-md-4 heading-contain">
                    <span>Parent Tree</span>
                  </div>
                  <div class="col-md-4 heading-contain">
                    <span>Title</span>
                  </div>
                  <div class="col-md-4 heading-contain">
                    <span>Amount</span>
                  </div>
                </div>
                <div *ngIf="selectedRequest.quarterAdvanceList[step]?.data !== null">
                  <div class="row d-flex cost-box align-items-center mt-2"
                    *ngFor="let item of selectedRequest.quarterAdvanceList[step].data; let i = index;">
                    <div class="col-md-4">
                      <span>
                        <div *ngIf="item?.parentCosts">
                          <div *ngFor="let _ of item?.parentCosts; let i = index">
                            <ng-container *ngIf="item?.parentCosts[item?.parentCosts.length-i-1] as name">
                              <small>{{name}}</small>
                              <small id="comment">{{i !== (item?.parentCosts.length - 1) ? ' ->' : '&nbsp;'}}</small>
                            </ng-container>
                          </div>
                        </div>
                      </span>
                    </div>
                    <div class="col-md-4">
                      <span>{{item.title}}</span>
                    </div>
                    <div class="col-md-4">
                      <span>{{item.amount | number}}</span>
                    </div>
                  </div>
                </div>
                <div class="row d-flex align-items-center header-box mt-2">
                  <div class="col-md-6 heading-contain">
                    <span class="pl-2">Total</span>
                  </div>
                  <div class="col-md-6 heading-contain">
                    <span *ngIf="selectedRequest !== null" class="pl-2">
                      {{selectedRequest.selectionType ?
                      selectedRequest.quarterAdvanceList[step] ?
                      (selectedRequest.quarterAdvanceList[step].amount | number) : '' :
                      ''}}
                    </span>
                  </div>
                </div>
              </div>
            </div>
            <!-- PROCESS OWNER FOR DISBURSEMENT -->
            <ng-container>
              <div class="row d-flex justify-content-between flex-fill p-3">
                <!-- SUBMIT YOUR REVIEW -->
                <div class="col-md-6" *ngIf="selectedRequest !== null && controlReviewUserForm">
                  <div *ngFor="let item of controlReviewUserForm.quarterAdvanceReviewsList">
                    <div *ngIf="item.assignee.id === loggedUser.id">
                      <p style="border-radius:5px;background-color: #f9f9f9;color: #151515;padding: 10px;">
                        <small>
                          <small id="answer" class="mr-1">
                            Comments from assigneer:
                          </small>
                          <small>
                            {{item.assignee.name}} please submit your review
                          </small>
                        </small>
                      </p>
                      <mat-form-field appearance="outline">
                        <mat-label>Your Reviews</mat-label>
                        <textarea [disabled]="item.status === 'Completed'" placeholder="Enter text here..."
                          [(ngModel)]="item.comments" matInput cols="30" rows="10"></textarea>
                      </mat-form-field>
                      <mat-radio-group class="mt-2 example-radio-group" [disabled]="item.status === 'Completed'"
                        [(ngModel)]="item.subStatus">
                        <mat-radio-button class="example-radio-button" value="Approve">
                          <span id="comment">{{'Approved' | uppercase}}</span>
                        </mat-radio-button>
                        <mat-radio-button class="example-radio-button" value="Reject">
                          <span id="warn-comment">{{'Rejected' | uppercase}}</span>
                        </mat-radio-button>
                      </mat-radio-group>
                      <button style="width: 100%;" class="d-flex flex-fill align-items-center justify-content-center"
                        color="primary" (click)="submitReview(item)"
                        [disabled]="!item.comments || item.status === 'Completed'" mat-raised-button>
                        Submit
                      </button>
                    </div>
                  </div>
                </div>
                <!-- ASSIGN USER FORM USERS -->
                <div class="col-md-6" *ngIf="selectedRequest?.assigned">
                  <div class="d-flex align-items-center heading-contain header-box">
                    <mat-icon>
                      settings_applications
                    </mat-icon>
                    <span class="pl-2">
                      Toolbox
                    </span>
                  </div>
                  <mat-form-field appearance="outline" class="mt-2">
                    <mat-label>Select User(s) For Reviews</mat-label>
                    <mat-select matNativeControl [compareWith]="compareSmeObjects" [formControl]="reviewUsers" multiple>
                      <mat-form-field class="p-3 filter-input" appearance="outline">
                        <mat-label>Filter By Department</mat-label>
                        <input matInput type="text" placeholder="Enter keyword..." [(ngModel)]="filterQuery">
                      </mat-form-field>
                      <mat-select-trigger>
                        <span *ngFor="let item of reviewUsers.value; let i=index">
                          <span *ngIf="i===0">{{item.name}}</span>
                        </span>
                        <span *ngIf="reviewUsers.value?.length > 1">
                          (+{{reviewUsers.value.length - 1}} others)
                        </span>
                      </mat-select-trigger>
                      <mat-optgroup *ngFor="let user of allUsers | depUserFilter:filterQuery" [label]="user.name">
                        <mat-option [hidden]="loggedUser.id === item.id || checkQuarterUserDisabled(item)"
                          *ngFor="let item of user.users" [value]="item">
                          {{item.name}}
                        </mat-option>
                      </mat-optgroup>
                    </mat-select>
                  </mat-form-field>
                  <div class="d-flex flex-fill justify-content-start">
                    <button style="width: 100%;" [disabled]="!reviewUsers.valid" class="mt-2 mb-2" mat-raised-button
                      color="primary" (click)="assignUsersForReviews('quarter')">
                      Assign For Reviews
                    </button>
                  </div>
                  <mat-chip-list *ngIf="controlReviewUserForm?.stats?.pendingCount || 
                                controlReviewUserForm?.stats?.completedCount" class="mt-3 review-chip">
                    <mat-chip (click)="getReviewsList(controlReviewUserForm.quarterAdvanceReviewsList);"
                      *ngIf="controlReviewUserForm?.stats?.pendingCount !== 0" class="mt-2" color="warn" selected>
                      {{controlReviewUserForm.stats ?
                      controlReviewUserForm.stats.pendingCount : '&nbsp;'}} Reviews Pending
                    </mat-chip>
                    <mat-chip (click)="getReviewsList(controlReviewUserForm.quarterAdvanceReviewsList);"
                      *ngIf="controlReviewUserForm?.stats?.completedCount !== 0" class="mt-2" color="accent" selected>
                      {{controlReviewUserForm.stats ?
                      controlReviewUserForm.stats.completedCount : '&nbsp;'}} Reviews Submitted
                    </mat-chip>
                  </mat-chip-list>
                </div>
              </div>
            </ng-container>
          </div>
        </ng-container>

        <!-- ASSIGNED REVIEWS LIST -->
        <ng-container *ngIf="selectedRequest?.assigned">
          <div class="row mt-5" *ngIf="currentReviewsList.length !== 0">
            <div class="d-flex flex-fill align-items-center heading-contain header-box">
              <mat-icon>
                settings_applications
              </mat-icon>
              <span class="pl-2">
                Reviews History
              </span>
              <div class="example-spacer">
              </div>
              <mat-icon style="cursor: pointer;" class="ml-2" (click)="currentReviewsList = [];">
                disabled_by_default
              </mat-icon>
            </div>
          </div>
          <div class="row">
            <div class="col-md-12 d-flex cost-box align-items-center mt-2"
              *ngFor="let item of currentReviewsList; let i = index;">
              <div class="col-md-3">
                <span>{{item.assignee.name}}</span>
              </div>
              <div class="col-md-3">
                <span id="warn-comment" *ngIf="item.status === 'Pending'">{{item.status}}</span>
                <span id="comment" *ngIf="item.status === 'Completed'">{{item.status}}</span>
              </div>
              <div class="col-md-6">
                <span>{{item.comments}}</span>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- LIQUIDATION FOR ADVANCE -->
        <div class="border-heading mt-5" *ngIf="selectedAdvanceItem?.subStatus === 'Approved'">
          <span>Advance Liquidation</span>
        </div>

        <div *ngIf="selectedAdvanceItem?.subStatus === 'Approved'">

          <!-- LIQUIDATION PRINT BOX -->
          <div class="row mb-2">
            <div class="col-md-12 mb-3">
              <div class="d-flex flex-fill justify-content-between align-items-center">
                <div class="d-flex align-items-center" style="width: 33%;">
                  <span
                    style="text-align:center;border: 1px solid;padding: 2px 10px;margin-right:10px;width:15%;">&nbsp;</span>
                  <span>Initial Advance</span>
                </div>
                <div class="d-flex align-items-center" style="width: 33%;">
                  <span
                    style="text-align:center;border: 1px solid;padding: 2px 10px;margin-right:10px;width:15%;">X</span>
                  <span>Liquidation Only</span>
                </div>
                <div class="d-flex align-items-center" style="width: 33%;">
                  <span
                    style="text-align:center;border: 1px solid;padding: 2px 10px;margin-right:10px;width:15%;">&nbsp;</span>
                  <span>Liquidation & Replenishment</span>
                </div>
              </div>
            </div>
            <div class="col-md-12 mb-3">
              <div class="d-flex flex-fill justify-content-between align-items-center">
                <div class="d-flex align-items-center" style="width: 33%;">
                  <span
                    style="text-align:center;border: 1px solid;padding: 2px 10px;margin-right:10px;width:15%;">&nbsp;</span>
                  <span>Advance</span>
                </div>
                <div class="d-flex align-items-center" style="width: 33%;">
                  <span
                    style="text-align:center;border: 1px solid;padding: 2px 10px;margin-right:10px;width:15%;">&nbsp;</span>
                  <span>Replenishment</span>
                </div>
                <div class="d-flex align-items-center" style="width: 33%;">
                  <span
                    style="text-align:center;border: 1px solid;padding: 2px 10px;margin-right:10px;width:15%;">&nbsp;</span>
                  <span>Direct Payment</span>
                </div>
              </div>
            </div>
          </div>

          <!-- LIQUIDATION EXTRA FROM FIELDS -->
          <div class="row mt-3 mb-3" *ngIf="selectedAdvanceLiquidation !== null">
            <div class="col-md-12">
              <mat-form-field appearance="outline">
                <mat-label>Payees Name</mat-label>
                <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')"
                  [(ngModel)]="selectedAdvanceLiquidation.payeesName" matInput type="text" placeholder="enter here...">
              </mat-form-field>
            </div>
            <div class="col-md-12">
              <mat-form-field appearance="outline">
                <mat-label>Payees Address</mat-label>
                <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')"
                  [(ngModel)]="selectedAdvanceLiquidation.payeesAddress" matInput type="text"
                  placeholder="enter here...">
              </mat-form-field>
            </div>
            <div class="col-md-12">
              <mat-form-field appearance="outline">
                <mat-label>Bank Name</mat-label>
                <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')"
                  [(ngModel)]="selectedAdvanceLiquidation.bankName" matInput type="text" placeholder="enter here...">
              </mat-form-field>
            </div>
            <div class="col-md-12">
              <mat-form-field appearance="outline">
                <mat-label>Bank Address</mat-label>
                <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')"
                  [(ngModel)]="selectedAdvanceLiquidation.bankAddress" matInput type="text" placeholder="enter here...">
              </mat-form-field>
            </div>
            <div class="col-md-6">
              <mat-form-field appearance="outline">
                <mat-label>Payees Account #</mat-label>
                <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')"
                  [(ngModel)]="selectedAdvanceLiquidation.payeesAccount" matInput type="text"
                  placeholder="enter here...">
              </mat-form-field>
            </div>
            <div class="col-md-6">
              <mat-form-field appearance="outline">
                <mat-label>Swift Code</mat-label>
                <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')"
                  [(ngModel)]="selectedAdvanceLiquidation.swiftCode" matInput type="text" placeholder="enter here...">
              </mat-form-field>
            </div>
            <div class="col-md-12">
              <mat-form-field appearance="outline">
                <mat-label>Special Payment Instruction</mat-label>
                <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')"
                  [(ngModel)]="selectedAdvanceLiquidation.specialPaymentInstruction" matInput type="text"
                  placeholder="enter here...">
              </mat-form-field>
            </div>
          </div>

          <!-- BUDGET UTILIZATION NDRMF -->
          <div *ngIf="selectedAdvanceItem?.subStatus === 'Approved'" class="mb-3">
            <p id="answer" class="p-2">Summary Budget Utilization (NDRMF Share)</p>
            <div class="d-flex align-items-center justify-content-between rag-div table-header">
              <span>
                Parent Tree
              </span>
              <span>
                Budget Category
              </span>
              <span>
                Total Project Budget Allocation (c)
              </span>
              <span>
                Expenditure upto last quarter (d)
              </span>
              <span>
                Expenditure for the current quarter (e)
              </span>
              <span>
                Expenditure till date (f = d+e)
              </span>
              <span>
                Remaining Budget (g = c-f)
              </span>
              <span>
                Remarks
              </span>
            </div>

            <div *ngFor="let item of selectedAdvanceLiquidation?.data; let i = index;">
              <div class="d-flex rag-div justify-content-between align-items-center table-row">
                <span>
                  <div *ngIf="item?.parentCosts">
                    <div *ngFor="let _ of item?.parentCosts; let i = index">
                      <ng-container *ngIf="item?.parentCosts[item?.parentCosts.length-i-1] as name">
                        <small>{{name}}</small>
                        <small id="comment">{{i !== (item?.parentCosts.length - 1) ? ' ->' : '&nbsp;'}}</small>
                      </ng-container>
                    </div>
                  </div>
                </span>
                <span>{{item.title}}</span>
                <span>{{getNdrmfTotalBudgetAllocation(item) | number}}</span>
                <span>{{'&nbsp;'}}</span>
                <span>{{getNdrmfExpenditureCurrentQuarter(item, 'quarter') | number}}</span>
                <span>{{(0 + getNdrmfExpenditureCurrentQuarter(item, 'quarter')) | number}}</span>
                <span>{{(getNdrmfTotalBudgetAllocation(item) - getNdrmfExpenditureCurrentQuarter(item, 'quarter')) |
                  number}}</span>
                <span>&nbsp;</span>
              </div>
            </div>

          </div>

          <!-- SUMMARY SOEs NDRMF -->
          <div *ngIf="selectedAdvanceItem?.subStatus === 'Approved'" class="mb-3">
            <p id="answer" class="p-2">Summary of SOE (NDRMF Share)</p>
            <div class="d-flex align-items-center justify-content-between rag-div table-header">
              <span>
                Parent Tree
              </span>
              <span>
                Budget Category
              </span>
              <span>
                Quarter Budget Allocation (c)
              </span>
              <span>
                Quarter Expenditure (SOE) (d)
              </span>
              <span>
                Variance - favorable / unfavorable (e = c - d)
              </span>
              <span>
                % Variance
              </span>
              <span>
                Remarks
              </span>
            </div>

            <div *ngFor="let item of selectedAdvanceLiquidation?.data; let i = index;">
              <div class="d-flex rag-div justify-content-between align-items-center table-row">
                <span>
                  <div *ngIf="item?.parentCosts">
                    <div *ngFor="let _ of item?.parentCosts; let i = index">
                      <ng-container *ngIf="item?.parentCosts[item?.parentCosts.length-i-1] as name">
                        <small>{{name}}</small>
                        <small id="comment">{{i !== (item?.parentCosts.length - 1) ? ' ->' : '&nbsp;'}}</small>
                      </ng-container>
                    </div>
                  </div>
                </span>
                <span>{{item.title}}</span>
                <span>{{getNdrmfQuarterBudgetAllocation(item) | number}}</span>
                <span>{{getNdrmfExpenditureCurrentQuarter(item, 'quarter') | number}}</span>
                <span>{{(getNdrmfQuarterBudgetAllocation(item) - getNdrmfExpenditureCurrentQuarter(item, 'quarter')) |
                  number}}</span>
                <span>{{'&nbsp;'}}</span>
                <span>{{'&nbsp;'}}</span>
              </div>
            </div>

          </div>

          <!-- NDRMF SOEs -->
          <div class="mb-3">
            <div class="d-flex justify-content-between mt-2 mb-2">
              <p id="answer" class="p-2">SOEs for NDRMF</p>
              <!-- <button mat-mini-fab color="accent" (click)="addNdrmfSoes();">
                                          <mat-icon>add</mat-icon>
                                        </button> -->
            </div>
            <div class="table-header rag-div d-flex align-items-center">
              <span class="p-2">Categories</span>
              <span class="p-2">Vendor Name</span>
              <span class="p-2">Invoice amount</span>
              <span class="p-2">Date of Payment</span>
              <span class="p-2">Paid Amount</span>
              <span class="p-2">Cheque #</span>
              <span class="p-2">Remarks</span>
            </div>

            <div>
              <div *ngFor="let item of ndrmfLiquidationSoes; let i = index;">
                <div class="d-flex rag-div justify-content-between align-items-center table-row">
                  <span class="">
                    <mat-form-field appearance="outline">
                      <mat-label>Select Activity</mat-label>
                      <mat-select [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')" matNativeControl [(ngModel)]="item.activityId">
                        <mat-option *ngFor="let obj of selectedAdvanceLiquidation?.data" [value]="obj._id">{{obj.title
                          | titlecase}}</mat-option>
                      </mat-select>
                    </mat-form-field>
                  </span>
                  <span class="">
                    <mat-form-field appearance="outline">
                      <mat-label>Vendor Name</mat-label>
                      <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')" type="text" [(ngModel)]="item.vendorName"
                        placeholder="enter here..." matInput>
                    </mat-form-field>
                  </span>
                  <span class="">
                    <mat-form-field appearance="outline">
                      <mat-label>Total Bill / Invoice amount</mat-label>
                      <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')" type="number" [(ngModel)]="item.invoiceAmount"
                        placeholder="enter here..." matInput>
                    </mat-form-field>
                  </span>
                  <span class="">
                    <mat-form-field appearance="outline"
                      *ngIf="loggedUser.role === 'fip' || (selectedAdvanceLiquidation?.status === 'Re Assigned' ||
                                    selectedAdvanceLiquidation?.status === 'Not Initiated') || item.dateOfPayment === null">
                      <mat-label>Date of Payment</mat-label>
                      <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')" matInput [matDatepicker]="picker3"
                        [(ngModel)]="item.dateOfPayment">
                      <mat-datepicker-toggle matSuffix [for]="picker3"></mat-datepicker-toggle>
                      <mat-datepicker #picker3></mat-datepicker>
                    </mat-form-field>
                    <small id="date-field" *ngIf="loggedUser.role !== 'fip' && item.dateOfPayment !== null">
                      {{item.dateOfPayment |
                      date:'shortDate'}}</small>
                  </span>
                  <span class="">
                    <mat-form-field appearance="outline">
                      <mat-label>Paid Amount</mat-label>
                      <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')" type="number" [(ngModel)]="item.paidAmount"
                        placeholder="enter here..." matInput>
                    </mat-form-field>
                  </span>
                  <span class="">
                    <mat-form-field appearance="outline">
                      <mat-label>Cheque #</mat-label>
                      <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')" type="text" [(ngModel)]="item.chequeNumber"
                        placeholder="enter here..." matInput>
                    </mat-form-field>
                  </span>
                  <span class="">
                    <mat-form-field appearance="outline">
                      <mat-label>Remarks</mat-label>
                      <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')" type="text" [(ngModel)]="item.remarks"
                        placeholder="enter here..." matInput>
                    </mat-form-field>
                  </span>
                </div>
              </div>
            </div>
            <div class="d-flex justify-content-end mt-2 mb-2" *ngIf="loggedUser?.role === 'fip'">
              <button [disabled]="selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review'" mat-flat-button color="accent"
                (click)="addNdrmfSoes();">
                <mat-icon>add</mat-icon> Add SOE
              </button>
            </div>

          </div>


          <!-- SUMMARY SOEs FIP -->
          <div *ngIf="selectedAdvanceItem?.subStatus === 'Approved'" class="mb-3">
            <p id="answer" class="p-2">Summary Budget Utilization (FIP Share)</p>
            <div class="d-flex align-items-center justify-content-between rag-div table-header">
              <span>
                Parent Tree
              </span>
              <span>
                Budget Category
              </span>
              <span>
                Total Project Budget Allocation (c)
              </span>
              <span>
                Expenditure upto last quarter (d)
              </span>
              <span>
                Expenditure for the current quarter (e)
              </span>
              <span>
                Expenditure till date (f = d+e)
              </span>
              <span>
                Remaining Budget (g = c-f)
              </span>
              <span>
                Remarks
              </span>
            </div>

            <div *ngFor="let item of selectedAdvanceLiquidation?.data; let i = index;">
              <div class="d-flex rag-div justify-content-between align-items-center table-row">
                <span>
                  <div *ngIf="item?.parentCosts">
                    <div *ngFor="let _ of item?.parentCosts; let i = index">
                      <ng-container *ngIf="item?.parentCosts[item?.parentCosts.length-i-1] as name">
                        <small>{{name}}</small>
                        <small id="comment">{{i !== (item?.parentCosts.length - 1) ? ' ->' : '&nbsp;'}}</small>
                      </ng-container>
                    </div>
                  </div>
                </span>
                <span>{{item.title}}</span>
                <span>{{getFipTotalBudgetAllocation(item) | number}}</span>
                <span>{{'&nbsp;'}}</span>
                <span>{{getFipExpenditureCurrentQuarter(item) | number}}</span>
                <span>{{(0 + getFipExpenditureCurrentQuarter(item)) | number}}</span>
                <span>{{(getFipTotalBudgetAllocation(item) - getFipExpenditureCurrentQuarter(item)) | number}}</span>
                <span>&nbsp;</span>
              </div>
            </div>

          </div>

          <!-- SUMMARY SOEs FIP -->
          <div *ngIf="selectedAdvanceItem?.subStatus === 'Approved'" class="mb-3">
            <p id="answer" class="p-2">Summary of SOE (FIP Share)</p>
            <div class="d-flex align-items-center justify-content-between rag-div table-header">
              <span>
                Parent Tree
              </span>
              <span>
                Budget Category
              </span>
              <span>
                Quarter Budget Allocation (c)
              </span>
              <span>
                Quarter Expenditure (SOE) (d)
              </span>
              <span>
                Variance - favorable / unfavorable (e = c - d)
              </span>
              <span>
                % Variance
              </span>
              <span>
                Remarks
              </span>
            </div>

            <div *ngFor="let item of selectedAdvanceLiquidation?.data; let i = index;">
              <div class="d-flex rag-div justify-content-between align-items-center table-row">
                <span>
                  <div *ngIf="item?.parentCosts">
                    <div *ngFor="let _ of item?.parentCosts; let i = index">
                      <ng-container *ngIf="item?.parentCosts[item?.parentCosts.length-i-1] as name">
                        <small>{{name}}</small>
                        <small id="comment">{{i !== (item?.parentCosts.length - 1) ? ' ->' : '&nbsp;'}}</small>
                      </ng-container>
                    </div>
                  </div>
                </span>
                <span>{{item.title}}</span>
                <span>{{getFipQuarterBudgetAllocation(item) | number}}</span>
                <span>{{getFipExpenditureCurrentQuarter(item) | number}}</span>
                <span>{{(getFipQuarterBudgetAllocation(item) - getFipExpenditureCurrentQuarter(item)) |
                  number}}</span>
                <span>{{'&nbsp;'}}</span>
                <span>{{'&nbsp;'}}</span>
              </div>
            </div>

          </div>

          <!-- FIP SOEs -->
          <ng-container>
            <div class="mb-3">
              <div class="d-flex justify-content-between mt-2 mb-2">
                <p id="answer" class="p-2">SOEs for FIP</p>
                <!-- <button mat-mini-fab color="accent" (click)="addFipSoes();">
                        <mat-icon>add</mat-icon>
                      </button> -->
              </div>
              <div class="table-header rag-div d-flex align-items-center">
                <span class="p-2">Categories</span>
                <span class="p-2">Vendor Name</span>
                <span class="p-2">Invoice amount</span>
                <span class="p-2">Date of Payment</span>
                <span class="p-2">Paid Amount</span>
                <span class="p-2">Cheque #</span>
                <span class="p-2">Remarks</span>
              </div>

              <div>
                <div *ngFor="let item of fipLiquidationSoes; let i = index;">
                  <div class="d-flex rag-div justify-content-between align-items-center table-row">
                    <span class="">
                      <mat-form-field appearance="outline">
                        <mat-label>Select Activity</mat-label>
                        <mat-select [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')" matNativeControl [(ngModel)]="item.activityId">
                          <mat-option *ngFor="let obj of selectedAdvanceLiquidation?.data" [value]="obj._id">{{obj.title
                            | titlecase}}</mat-option>
                        </mat-select>
                      </mat-form-field>
                    </span>
                    <span class="">
                      <mat-form-field appearance="outline">
                        <mat-label>Vendor Name</mat-label>
                        <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')" type="text" [(ngModel)]="item.vendorName"
                          placeholder="enter here..." matInput>
                      </mat-form-field>
                    </span>
                    <span class="">
                      <mat-form-field appearance="outline">
                        <mat-label>Total Bill / Invoice amount</mat-label>
                        <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')" type="text" [(ngModel)]="item.invoiceAmount"
                          placeholder="enter here..." matInput>
                      </mat-form-field>
                    </span>
                    <span class="">
                      <mat-form-field appearance="outline" *ngIf="loggedUser.role === 'fip' || (selectedAdvanceLiquidation?.status === 'Re Assigned' ||
                selectedAdvanceLiquidation?.status === 'Not Initiated') || item.dateOfPayment === null">
                        <mat-label>Date of Payment</mat-label>
                        <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')" matInput [matDatepicker]="picker42"
                          [(ngModel)]="item.dateOfPayment">
                        <mat-datepicker-toggle matSuffix [for]="picker42"></mat-datepicker-toggle>
                        <mat-datepicker #picker42></mat-datepicker>
                      </mat-form-field>
                      <small id="date-field" *ngIf="loggedUser.role !== 'fip' && item.dateOfPayment !== null">
                        {{item.dateOfPayment |
                        date:'shortDate'}}</small>
                    </span>
                    <span class="">
                      <mat-form-field appearance="outline">
                        <mat-label>Paid Amount</mat-label>
                        <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')" type="text" [(ngModel)]="item.paidAmount"
                          placeholder="enter here..." matInput>
                      </mat-form-field>
                    </span>
                    <span class="">
                      <mat-form-field appearance="outline">
                        <mat-label>Cheque #</mat-label>
                        <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')" type="text" [(ngModel)]="item.chequeNumber"
                          placeholder="enter here..." matInput>
                      </mat-form-field>
                    </span>
                    <span class="">
                      <mat-form-field appearance="outline">
                        <mat-label>Remarks</mat-label>
                        <input [disabled]="loggedUser.role !== 'fip' || (selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review')" type="text" [(ngModel)]="item.remarks"
                          placeholder="enter here..." matInput>
                      </mat-form-field>
                    </span>
                  </div>
                </div>
              </div>

              <div class="d-flex justify-content-end mt-2 mb-2" *ngIf="loggedUser?.role === 'fip'">

                <button [disabled]="selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review'" mat-flat-button color="accent"
                  (click)="addFipSoes();">
                  <mat-icon>add</mat-icon> Add SOE
                </button>
              </div>

            </div>
          </ng-container>
        </div>

        <mat-action-row>
          <!-- <button mat-button color="primary" (click)="nextStep('quarter')">Next</button> -->
          <div class="d-flex flex-fill justify-content-between">
            <div>
              <div class="d-flex flex-column">
                <div class="mb-2">
                  <span id="answer">Advance Status:</span>
                  {{selectedAdvanceItem?.subStatus}}
                </div>
                <div>
                  <span id="answer">Liquidation Status:</span>
                  {{selectedAdvanceLiquidation?.status}}
                </div>
              </div>
            </div>
            <div *ngIf="selectedRequest?.assigned" class="d-flex flex-column">

              <button class="mb-2"
                [disabled]="(selectedAdvanceItem?.subStatus === 'Approved' ||
              selectedAdvanceItem?.subStatus === null || selectedAdvanceItem?.status === 'Re Assigned') || approveLoading"
                mat-raised-button color="accent" (click)="approveQuarterAdvance()">
                Approve Quarter Advance
              </button>
              <button class="mb-2" [disabled]="selectedAdvanceItem?.status === 'Re Assigned' || 
            selectedAdvanceItem?.status === null || selectedAdvanceItem?.status === 'Approved' 
            || selectedAdvanceLiquidation?.subStatus === 'Approved' || 
            approveLoading" mat-raised-button color="warn" (click)="reassignQuarterAdvance()">
                Reassign Quarter Advance
              </button>
              <!-- <button class="mb-2" mat-raised-button color="accent" (click)="approveQuarterAdvance()">
                Approve Quarter Advance
              </button> -->
              <div class="mb-2">
                <mat-divider></mat-divider>
              </div>
              <button class="mb-2" [disabled]="selectedAdvanceLiquidation?.status === 'Not Initiated' ||
               selectedAdvanceLiquidation?.status === 'Approved' || selectedAdvanceLiquidation?.status === 'Re Assigned'
               || approveLoading || selectedAdvanceItem?.data === null || 
               selectedAdvanceLiquidation === null || selectedAdvanceItem?.status === 'Re Assigned'" mat-raised-button
                color="accent" (click)="approveQuarterLiquidation()">
                Approve Quarter Liquidation
              </button>
              <button [disabled]="selectedAdvanceLiquidation?.status === 'Re Assigned' || 
              selectedAdvanceLiquidation?.status === 'Not Initiated' || approveLoading || 
              selectedAdvanceLiquidation === null || selectedAdvanceItem?.status === 'Re Assigned'" mat-raised-button
                color="accent" (click)="reassignQuarterLiquidation()">
                Reassign Quarter Liquidation
              </button>
            </div>
            <div *ngIf="loggedUser?.role === 'fip'">
              <div>
                <button *ngIf="!approveLoading && selectedAdvanceItem?.subStatus === 'Approved'"
                  [disabled]="(selectedAdvanceLiquidation?.status === 'Approved' ||
                selectedAdvanceLiquidation?.status === 'Under Review' || selectedAdvanceItem?.status === 'Re Assigned')" mat-raised-button color="accent" (click)="submitAdvanceLiquidation()">
                  {{ (selectedAdvanceItem?.status === null ||
                  selectedAdvanceLiquidation?.status === 'Not Initiated') ?
                  'Submit Quarter Liquidation' : 'Update Quarter Liquidation'}}
                </button>
                <mat-progress-spinner *ngIf="approveLoading" mode="indeterminate" diameter="20"></mat-progress-spinner>
              </div>
            </div>
          </div>
        </mat-action-row>
      </mat-expansion-panel>
    </mat-accordion>
  </ng-container>
</div>